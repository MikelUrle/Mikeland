<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <title>Mikeland</title>
  <link rel="stylesheet" href="./styles/menu.css">
  <link rel="stylesheet" href="./styles/index.css">
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/main.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11" defer></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-LN+7fdVzj6u52u30Kp6M/trliBMCMKTyK833zpbD+pXdCLuTusPj697FH4R/5mcr" crossorigin="anonymous">
  <style>
    .category-section h6 {
      font-weight: 600;
      color: #555;
      margin-bottom: 0.5rem;
      border-bottom: 1px solid #ddd;
      padding-bottom: 0.25rem;
    }

    .category-section ul {
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      background-color: #fff;
    }

    .category-section {
      background-color: #fafafa;
      padding: 0.5rem;
      border-radius: 10px;
    }
  </style>
</head>

<body>

  <div class="modal fade" id="exportModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Enviar receta por correo</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <label for="email-destino" class="form-label">Correo de destino:</label>
          <input type="email" id="email-destino" class="form-control" placeholder="ejemplo@correo.com" required>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-primary" id="send-email">Enviar</button>
        </div>
      </div>
    </div>
  </div>


  <div id="sidebar"></div>

  <div class="main">
    <div class="recipe-container container mt-4">
      <div class="row">
        <!-- Lista de recetas -->
        <!-- Lista de recetas con categorías -->
        <div class="col-md-4">
          <h4 class="mb-3">Mis Recetas</h4>

          <div class="category-section mb-3">
            <h6>🍲 Primeros platos</h6>
            <ul id="recipe-list-primeros" class="list-group mb-3"></ul>
          </div>

          <div class="category-section mb-3">
            <h6>🍖 Segundos platos</h6>
            <ul id="recipe-list-segundos" class="list-group mb-3"></ul>
          </div>

          <div class="category-section mb-3">
            <h6>🍰 Postres</h6>
            <ul id="recipe-list-postres" class="list-group mb-3"></ul>
          </div>

          <div class="category-section mb-3">
            <h6>🗂️ Genéricas</h6>
            <ul id="recipe-list-genericas" class="list-group mb-3"></ul>
          </div>

          <button id="add-recipe" class="btn btn-primary mt-3 w-100">➕ Nueva receta</button>
        </div>

        <!-- Vista / Edición de la receta -->
        <div class="col-md-8">
          <div class="card shadow-sm p-3">
            <input type="text" id="recipe-title" class="form-control mb-3" placeholder="Selecciona o crea una receta" />

            <!-- Foto -->
            <div class="text-center mb-3">
              <img style="height: 200px; width: 300px;" id="recipe-image" src="./Imagenes/Receta Genérica.jpg"
                alt="Foto de receta" class="img-fluid rounded mb-2">
              <input type="file" id="upload-image" class="form-control" accept="image/*">
            </div>

            <!-- Ingredientes -->
            <h5>🧂 Ingredientes</h5>
            <textarea id="recipe-ingredients" class="form-control mb-3" rows="5"
              placeholder="Lista de ingredientes..."></textarea>

            <!-- Pasos -->
            <h5>👨‍🍳 Preparación</h5>
            <textarea id="recipe-steps" class="form-control mb-3" rows="8"
              placeholder="Escribe los pasos de la receta..."></textarea>

            <div class="d-flex justify-content-end gap-2">
              <button id="export-recipe" class="btn btn-secondary">📤 Exportar</button>
              <button id="save-recipe" class="btn btn-success">💾 Guardar</button>
              <button id="delete-recipe" class="btn btn-danger">🗑️ Eliminar</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-ndDqU0Gzau9qJ1lfW4pNLlhNTkCfHzAVBReH9diLvGRem5+R9g2FzA8ZGN954O5Q"
    crossorigin="anonymous"></script>
  <script defer>
    document.addEventListener('DOMContentLoaded', () => {
      fetch('./menu.html')
        .then(res => res.text())
        .then(html => {
          document.getElementById('sidebar').innerHTML = html;
        });


      const lists = {
        primeros: document.getElementById('recipe-list-primeros'),
        segundos: document.getElementById('recipe-list-segundos'),
        postres: document.getElementById('recipe-list-postres'),
        genericas: document.getElementById('recipe-list-genericas')
      };

      const addBtn = document.getElementById('add-recipe');
      const saveBtn = document.getElementById('save-recipe');
      const deleteBtn = document.getElementById('delete-recipe');
      const imgInput = document.getElementById('upload-image');

      const titleEl = document.getElementById('recipe-title');
      const imgEl = document.getElementById('recipe-image');
      const ingEl = document.getElementById('recipe-ingredients');
      const stepsEl = document.getElementById('recipe-steps');

      let recipes = [];
      let selectedIndex = null;

      // 🔹 Cargar recetas desde backend
      async function chargueData() {
        try {
          const res = await fetch('./controllers/recetas/listado_recetas.php');
          recipes = await res.json();

          // Filtra recetas no eliminadas
          recipes = recipes.filter(r => r.isDeleted === "0");

          renderList();
        } catch (err) {
          console.error('Error cargando recetas:', err);
        }
      }

      // 🔹 Renderizar listas por categoría
      const renderList = () => {
        Object.values(lists).forEach(list => list.innerHTML = '');

        recipes.forEach((r, i) => {
          const li = document.createElement('li');
          li.className = 'list-group-item list-group-item-action';
          li.textContent = r.nombre || 'Sin título';
          li.onclick = () => selectRecipe(i);

          const categoria = mapCategoria(r.id_categoria);
          lists[categoria].appendChild(li);
        });
      };

      // 🔹 Mapear id_categoria a nombre de lista
      const mapCategoria = (id) => {
        switch (id) {
          case "1": return "primeros";
          case "2": return "segundos";
          case "3": return "postres";
          default: return "genericas";
        }
      };

      // 🔹 Seleccionar receta
      const selectRecipe = (index) => {
        selectedIndex = index;
        const r = recipes[index];

        titleEl.value = r.nombre;
        imgEl.src = r.foto
          ? `./imagenes/${r.foto}`
          : 'https://via.placeholder.com/400x250?text=Sin+foto';
        ingEl.value = r.ingredientes || '';
        stepsEl.value = r.preparacion || '';

        // ✅ Asignar correctamente la categoría
        categorySelect.value = r.id_categoria || "4";
      };

      addBtn.onclick = async () => {
        // Datos por defecto de la nueva receta
        const newRecipe = {
          nombre: 'Nueva receta',
          ingredientes: '',
          preparacion: '',
          id_categoria: 4 // genérica
        };

        try {
          const res = await fetch('./controllers/recetas/crear_receta.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(newRecipe)
          });

          const result = await res.json();

          if (result.success) {
            alert('Receta creada ✅');

            // Añadimos la nueva receta a memoria
            recipes.push({
              id_receta: result.id_receta,
              ...newRecipe,
              isDeleted: "0"
            });

            // Seleccionamos la nueva receta
            selectedIndex = recipes.length - 1;

            renderList();
            selectRecipe(selectedIndex);
          } else {
            alert('❌ No se pudo crear la receta');
            console.error(result.error);
          }
        } catch (err) {
          console.error('Error al crear receta:', err);
          alert('❌ Error de conexión con el servidor');
        }
      };

      // 🔹 Subir imagen
      imgInput.onchange = (e) => {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = () => {
            imgEl.src = reader.result;
          };
          reader.readAsDataURL(file);
        }
      };

      // 🔹 Selector de categoría en el editor
      const card = document.querySelector('#recipe-editor .card') || document.querySelector('.card');
      const categoryHTML = `
      <div class="mb-3">
        <label for="category" class="form-label">Categoría</label>
        <select id="category" class="form-select">
          <option value="1">🍲 Primer plato</option>
          <option value="2">🍖 Segundo plato</option>
          <option value="3">🍰 Postre</option>
          <option value="4">🗂️ Genérica</option>
        </select>
      </div>`;
      card.insertAdjacentHTML('beforeend', categoryHTML);

      const categorySelect = document.getElementById('category');

      // 🔹 Cargar datos al iniciar
      chargueData();



      saveBtn.onclick = async () => {
        if (selectedIndex === null) return alert('Selecciona una receta');

        const r = recipes[selectedIndex];

        const formData = new FormData();
        formData.append('id_receta', r.id_receta);
        formData.append('nombre', titleEl.value.trim());
        formData.append('ingredientes', ingEl.value.trim());
        formData.append('preparacion', stepsEl.value.trim());
        formData.append('id_categoria', categorySelect.value);

        // 📸 Añadir la imagen si el usuario seleccionó una nueva
        if (imgInput.files && imgInput.files[0]) {
          formData.append('foto', imgInput.files[0]);
        }

        try {
          const res = await fetch('./controllers/recetas/guardar_receta.php', {
            method: 'POST',
            body: formData
          });

          const result = await res.json();

          if (result.success) {
            alert('Receta guardada ✅');

            // Actualiza los datos en memoria
            r.nombre = titleEl.value.trim();
            r.ingredientes = ingEl.value.trim();
            r.preparacion = stepsEl.value.trim();
            r.id_categoria = categorySelect.value;
            if (result.foto) r.foto = result.foto; // actualizar el nombre de archivo

            renderList();
            selectRecipe(selectedIndex);
          } else {
            alert('⚠️ Error al guardar receta');
            console.error(result.error);
          }
        } catch (err) {
          console.error('Error al guardar receta:', err);
          alert('❌ Error de conexión con el servidor');
        }
      };



      const exportBtn = document.getElementById('export-recipe');
      const sendEmailBtn = document.getElementById('send-email');
      const emailInput = document.getElementById('email-destino');

      exportBtn.onclick = () => {
        if (selectedIndex === null) return alert('Selecciona una receta primero');
        const modal = new bootstrap.Modal(document.getElementById('exportModal'));
        modal.show();
      };

      sendEmailBtn.onclick = async () => {
        if (selectedIndex === null) return alert('Selecciona una receta');
        const emailDestino = emailInput.value.trim();
        if (!emailDestino) return alert('Introduce un correo válido');

        const receta = recipes[selectedIndex];

        const data = {
          id_receta: receta.id_receta,
          email_destino: emailDestino
        };

        try {
          const res = await fetch('./controllers/recetas/exportar_receta.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });

          const result = await res.json();
          if (result.success) {
            alert('📧 Receta enviada correctamente');
            bootstrap.Modal.getInstance(document.getElementById('exportModal')).hide();
          } else {
            alert('⚠️ Error al enviar el correo: ' + (result.error || 'Desconocido'));
          }
        } catch (err) {
          console.error('Error al enviar:', err);
          alert('❌ Error de conexión con el servidor');
        }
      };


    });


  </script>


</body>

</html>