<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <title>Mikeland</title>
  <link rel="stylesheet" href="./styles/menu.css">
  <link rel="stylesheet" href="./styles/index.css">
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/main.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11" defer></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-LN+7fdVzj6u52u30Kp6M/trliBMCMKTyK833zpbD+pXdCLuTusPj697FH4R/5mcr" crossorigin="anonymous">
  <style>
    .category-section h6 {
      font-weight: 600;
      color: #555;
      margin-bottom: 0.5rem;
      border-bottom: 1px solid #ddd;
      padding-bottom: 0.25rem;
    }

    .category-section ul {
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      background-color: #fff;
    }

    .category-section {
      background-color: #fafafa;
      padding: 0.5rem;
      border-radius: 10px;
    }
  </style>
</head>

<body>


  <div id="sidebar"></div>

  <div class="main">
    <div class="recipe-container container mt-4">
      <div class="row">
        <!-- Lista de recetas -->
        <!-- Lista de recetas con categorÃ­as -->
        <div class="col-md-4">
          <h4 class="mb-3">Mis Recetas</h4>

          <div class="category-section mb-3">
            <h6>ğŸ² Primeros platos</h6>
            <ul id="recipe-list-primeros" class="list-group mb-3"></ul>
          </div>

          <div class="category-section mb-3">
            <h6>ğŸ– Segundos platos</h6>
            <ul id="recipe-list-segundos" class="list-group mb-3"></ul>
          </div>

          <div class="category-section mb-3">
            <h6>ğŸ° Postres</h6>
            <ul id="recipe-list-postres" class="list-group mb-3"></ul>
          </div>

          <div class="category-section mb-3">
            <h6>ğŸ—‚ï¸ GenÃ©ricas</h6>
            <ul id="recipe-list-genericas" class="list-group mb-3"></ul>
          </div>

          <button id="add-recipe" class="btn btn-primary mt-3 w-100">â• Nueva receta</button>
        </div>

        <!-- Vista / EdiciÃ³n de la receta -->
        <div class="col-md-8">
          <div class="card shadow-sm p-3">
            <h3 id="recipe-title" class="mb-3">Selecciona o crea una receta</h3>

            <!-- Foto -->
            <div class="text-center mb-3">
              <img style="height: 200px; width: 300px;" id="recipe-image" src="./Imagenes/Receta GenÃ©rica.jpg"
                alt="Foto de receta" class="img-fluid rounded mb-2">
              <input type="file" id="upload-image" class="form-control" accept="image/*">
            </div>

            <!-- Ingredientes -->
            <h5>ğŸ§‚ Ingredientes</h5>
            <textarea id="recipe-ingredients" class="form-control mb-3" rows="5"
              placeholder="Lista de ingredientes..."></textarea>

            <!-- Pasos -->
            <h5>ğŸ‘¨â€ğŸ³ PreparaciÃ³n</h5>
            <textarea id="recipe-steps" class="form-control mb-3" rows="8"
              placeholder="Escribe los pasos de la receta..."></textarea>

            <div class="d-flex justify-content-end gap-2">
              <button id="save-recipe" class="btn btn-success">ğŸ’¾ Guardar</button>
              <button id="delete-recipe" class="btn btn-danger">ğŸ—‘ï¸ Eliminar</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-ndDqU0Gzau9qJ1lfW4pNLlhNTkCfHzAVBReH9diLvGRem5+R9g2FzA8ZGN954O5Q"
    crossorigin="anonymous"></script>
  <script defer>
    document.addEventListener('DOMContentLoaded', () => {
      fetch('./menu.html')
        .then(res => res.text())
        .then(html => {
          document.getElementById('sidebar').innerHTML = html;
        });


      const lists = {
        primeros: document.getElementById('recipe-list-primeros'),
        segundos: document.getElementById('recipe-list-segundos'),
        postres: document.getElementById('recipe-list-postres'),
        genericas: document.getElementById('recipe-list-genericas')
      };

      const addBtn = document.getElementById('add-recipe');
      const saveBtn = document.getElementById('save-recipe');
      const deleteBtn = document.getElementById('delete-recipe');
      const imgInput = document.getElementById('upload-image');

      const titleEl = document.getElementById('recipe-title');
      const imgEl = document.getElementById('recipe-image');
      const ingEl = document.getElementById('recipe-ingredients');
      const stepsEl = document.getElementById('recipe-steps');

      let recipes = [];
      let selectedIndex = null;

      // ğŸ”¹ Cargar recetas desde backend
      async function chargueData() {
        try {
          const res = await fetch('./controllers/recetas/listado_recetas.php');
          recipes = await res.json();

          // Filtra recetas no eliminadas
          recipes = recipes.filter(r => r.isDeleted === "0");

          renderList();
        } catch (err) {
          console.error('Error cargando recetas:', err);
        }
      }

      // ğŸ”¹ Renderizar listas por categorÃ­a
      const renderList = () => {
        Object.values(lists).forEach(list => list.innerHTML = '');

        recipes.forEach((r, i) => {
          const li = document.createElement('li');
          li.className = 'list-group-item list-group-item-action';
          li.textContent = r.nombre || 'Sin tÃ­tulo';
          li.onclick = () => selectRecipe(i);

          const categoria = mapCategoria(r.id_categoria);
          lists[categoria].appendChild(li);
        });
      };

      // ğŸ”¹ Mapear id_categoria a nombre de lista
      const mapCategoria = (id) => {
        switch (id) {
          case "1": return "primeros";
          case "2": return "segundos";
          case "3": return "postres";
          default: return "genericas";
        }
      };

      // ğŸ”¹ Seleccionar receta
      const selectRecipe = (index) => {
        selectedIndex = index;
        const r = recipes[index];

        titleEl.textContent = r.nombre;
        imgEl.src = r.foto
          ? `data:image/jpeg;base64,${r.foto}`
          : 'https://via.placeholder.com/400x250?text=Sin+foto';
        ingEl.value = r.ingredientes || '';
        stepsEl.value = r.preparacion || '';

        // âœ… Asignar correctamente la categorÃ­a
        categorySelect.value = r.id_categoria || "4";
      };

      // ğŸ”¹ Crear nueva receta (solo local por ahora)
      addBtn.onclick = () => {
        const newRecipe = {
          id_receta: Date.now().toString(),
          nombre: 'Nueva receta',
          ingredientes: '',
          preparacion: '',
          foto: null,
          id_categoria: "4", // genÃ©rica
          isDeleted: "0"
        };
        recipes.push(newRecipe);
        selectedIndex = recipes.length - 1;
        renderList();
        selectRecipe(selectedIndex);
      };

      // ğŸ”¹ Guardar receta (solo local; podrÃ­as hacer fetch POST aquÃ­)
      saveBtn.onclick = () => {
        if (selectedIndex === null) return alert('Selecciona una receta');
        const r = recipes[selectedIndex];

        r.nombre = titleEl.textContent;
        r.ingredientes = ingEl.value;
        r.preparacion = stepsEl.value;
        r.id_categoria = categorySelect.value;
        r.foto = imgEl.src.startsWith('data:image') ? imgEl.src.split(',')[1] : null;

        renderList();
        alert('Receta guardada âœ… (solo local)');
      };

      // ğŸ”¹ Eliminar receta (solo frontend)
      deleteBtn.onclick = () => {
        if (selectedIndex === null) return alert('Selecciona una receta');
        if (confirm('Â¿Eliminar esta receta?')) {
          recipes.splice(selectedIndex, 1);
          selectedIndex = null;
          titleEl.textContent = 'Selecciona o crea una receta';
          imgEl.src = 'https://via.placeholder.com/400x250?text=Sin+foto';
          ingEl.value = '';
          stepsEl.value = '';
          renderList();
        }
      };

      // ğŸ”¹ Subir imagen
      imgInput.onchange = (e) => {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = () => {
            imgEl.src = reader.result;
          };
          reader.readAsDataURL(file);
        }
      };

      // ğŸ”¹ Selector de categorÃ­a en el editor
      const card = document.querySelector('#recipe-editor .card') || document.querySelector('.card');
      const categoryHTML = `
      <div class="mb-3">
        <label for="category" class="form-label">CategorÃ­a</label>
        <select id="category" class="form-select">
          <option value="1">ğŸ² Primer plato</option>
          <option value="2">ğŸ– Segundo plato</option>
          <option value="3">ğŸ° Postre</option>
          <option value="4">ğŸ—‚ï¸ GenÃ©rica</option>
        </select>
      </div>`;
      card.insertAdjacentHTML('beforeend', categoryHTML);

      const categorySelect = document.getElementById('category');

      // ğŸ”¹ Cargar datos al iniciar
      chargueData();



    saveBtn.onclick = async () => {
      if (selectedIndex === null) return alert('Selecciona una receta');

      const r = recipes[selectedIndex];

      // Tomamos los valores actuales del formulario
      const updatedData = {
        id_receta: r.id_receta,
        nombre: titleEl.textContent.trim(),
        ingredientes: ingEl.value.trim(),
        preparacion: stepsEl.value.trim(),
        id_categoria: categorySelect.value
      };

      try {
        const res = await fetch('./controllers/recetas/guardar_receta.php', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(updatedData)
        });

        const result = await res.json();

        if (result.success) {
          // Actualizamos tambiÃ©n en memoria
          Object.assign(recipes[selectedIndex], updatedData);

          alert('Receta guardada correctamente âœ…');
          renderList();
        } else {
          alert('âš ï¸ No se pudo guardar la receta en el servidor');
          console.error(result);
        }
      } catch (err) {
        console.error('Error al guardar receta:', err);
        alert('âŒ Error al guardar la receta');
      }
    };



    });


  </script>


</body>

</html>