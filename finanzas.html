<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <title>Mikeland</title>
  <link rel="stylesheet" href="./styles/menu.css">
  <link rel="stylesheet" href="./styles/index.css">
  <link rel="stylesheet" href="./styles/finanzas.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js" defer></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-LN+7fdVzj6u52u30Kp6M/trliBMCMKTyK833zpbD+pXdCLuTusPj697FH4R/5mcr" crossorigin="anonymous">

</head>

<body>

  <div id="sidebar"></div>

  <div class="main">
    <h1>Finanzas</h1>

    <section id="patrimonio">
      <h2>Patrimonio Total</h2>
      <div id="patrimonio-total">0 €</div>
    </section>

    <section class="categorias-container">
      <div class="categoria">
        <h3>Banco</h3>
        <ul id="lista-banco"></ul>
      </div>

      <div class="categoria">
        <h3>Bolsa</h3>
        <ul id="lista-bolsa"></ul>
      </div>

      <div class="categoria">
        <h3>Extras</h3>
        <ul id="lista-extras"></ul>
      </div>
    </section>

    <section id="acciones">
      <button id="btn-add-subcategoria" onclick="nuevaSubCategoria(event)">+ Añadir Subcategoria</button>
      <button id="btn-add" onclick="nuevoMovimiento(event)">+ Añadir Movimiento</button>
    </section>

    <section id="historial">
      <h3>Historial de Movimientos</h3>
      <table>
        <thead>
          <tr>
            <th>Fecha</th>
            <th>Categoría</th>
            <th>Concepto</th>
            <th>Sub Categoria</th>
            <th>Cantidad (€)</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="tabla-movimientos">
          <!-- Aquí se insertarán los movimientos -->
        </tbody>
      </table>
    </section>

  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-ndDqU0Gzau9qJ1lfW4pNLlhNTkCfHzAVBReH9diLvGRem5+R9g2FzA8ZGN954O5Q"
    crossorigin="anonymous"></script>
  <script defer>
    document.addEventListener('DOMContentLoaded', () => {
      lucide.createIcons();
      fetch('./menu.html')
        .then(res => res.text())
        .then(html => {
          document.getElementById('sidebar').innerHTML = html;
        });
    });

let finanzas = {
  banco: [],
  bolsa: [],
  extras: []
};

const movimientos = [];
const subCategorias = [];

function procesarMovimientos(movimientos) {
  const nuevoFinanzas = {
    banco: [],
    bolsa: [],
    extras: []
  };

  const categoriasMap = {
    0: 'banco',
    1: 'bolsa',
    2: 'extras'
  };

  const acumulado = {};

  movimientos.forEach(mov => {
    const cat = parseInt(mov.categoria);
    const nombre = mov.nombre_sub_categoria;
    const cantidad = parseFloat(mov.cantidad);

    if (!categoriasMap.hasOwnProperty(cat) || mov.isDeleted === '1') return;

    const key = `${cat}_${nombre}`;

    if (!acumulado[key]) {
      acumulado[key] = {
        categoria: categoriasMap[cat],
        nombre,
        cantidad: 0
      };
    }

    acumulado[key].cantidad += cantidad;
  });

  Object.values(acumulado).forEach(({ categoria, nombre, cantidad }) => {
    nuevoFinanzas[categoria].push({ nombre, cantidad });
  });

  return nuevoFinanzas;
}

function renderFinanzas() {
  let total = 0;

  for (const categoria in finanzas) {
    const lista = document.getElementById(`lista-${categoria}`);
    lista.innerHTML = '';

    finanzas[categoria].sort((a, b) => b.cantidad - a.cantidad);

    finanzas[categoria].forEach(item => {
      total += item.cantidad;
      const li = document.createElement('li');
      li.textContent = `${item.nombre}: ${item.cantidad.toLocaleString()} €`;
      lista.appendChild(li);
    });
  }

  document.getElementById('patrimonio-total').textContent = total.toLocaleString() + ' €';
}

function initMovimientos() {
  return fetch('./controllers/movimientos.php')
    .then(response => response.json())
    .then(data => {
      movimientos.length = 0;
      data.forEach(item => {
        movimientos.push({
          id: item.id,
          fecha: item.fecha,
          categoria: item.categoria,
          concepto: item.concepto,
          cantidad: item.cantidad,
          nombre_sub_categoria: item.nombre_sub_categoria,
          isDeleted: item.isDeleted
        });
      });
      renderMovimientos();

      finanzas = procesarMovimientos(movimientos);
      renderFinanzas();
    })
    .catch(error => {
      console.error('Error al cargar los movimientos:', error);
    });
}

function initSubcategorias() {
  return fetch('./controllers/sub_categorias.php')
    .then(response => response.json())
    .then(data => {
      subCategorias.length = 0;
      data.forEach(item => {
        subCategorias.push({
          id: item.id,
          nombre: item.nombre
        });
      });
    })
    .catch(error => {
      console.error('Error al cargar las subcategorías:', error);
    });
}

function renderMovimientos() {
  const tbody = document.getElementById('tabla-movimientos');
  tbody.innerHTML = '';

  const categorias = {
    0: 'Banco',
    1: 'Bolsa',
    2: 'Extras'
  };

  movimientos.forEach(mov => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${mov.fecha.split(' ')[0]}</td>
      <td>${categorias[mov.categoria] || 'Desconocida'}</td>
      <td>${mov.concepto}</td>
      <td>${mov.nombre_sub_categoria || '-'}</td>
      <td style="color: ${mov.cantidad < 0 ? 'red' : 'green'}">
        ${Number(mov.cantidad).toLocaleString()} €
      </td>
      <td>
        <button 
          class="btn-delete" 
          onclick="registro_delete(event,${mov.id})">
          🗑️
        </button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

document.addEventListener('DOMContentLoaded', async () => {
  await initSubcategorias();
  await initMovimientos();
});


  async function registro_delete(event,id) {

      event.preventDefault();

      const result = await Swal.fire({
          title: "¿Estás seguro?",
          text: "¡Esto es irreversible!",
          icon: "warning",
          showCancelButton: true,
          confirmButtonColor: "#E63757",
          cancelButtonColor: "#748194",
          cancelButtonText: "Cancelar",
          confirmButtonText: "Sí, eliminar"
      });

      if (result.isConfirmed) {

          borrarMovimiento(id);

      }

  }

function borrarMovimiento(id) {

  fetch(`./controllers/borrar_movimiento.php?id=${id}`)
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        // Quitamos el movimiento del array
        movimientos.splice(movimientos.findIndex(m => m.id == id), 1);
        window.location.reload();
      } else {
        alert('Error al borrar el movimiento');
      }
    })
    .catch(err => console.error('Error:', err));
}


function nuevoMovimiento() {
  const subCategoriaOptions = subCategorias.map(sub => `
    <option value="${sub.id}">${sub.nombre}</option>
  `).join('');

  Swal.fire({
    title: 'Nuevo Movimiento',
    html: `
      <div style="display: flex; flex-direction: column; align-items: stretch; width: 100%; max-width: 500px; margin: auto; font-size: 16px;">
        <label for="fecha" style="margin-top: 10px;">📅 Fecha</label>
        <input type="date" id="fecha" class="swal2-input" style="width: 100%; height: 45px; font-size: 16px; margin-left:0px">

        <label for="categoria" style="margin-top: 10px; margin-bottom:10px">📂 Categoría</label>
        <select id="categoria" class="swal2-input" style="width: 100%; height: 45px; font-size: 16px;">
          <option value="0">Banco</option>
          <option value="1">Bolsa</option>
          <option value="2">Extras</option>
        </select>

        <label for="sub_categoria" style="margin-top: 10px; margin-bottom:10px">🏷️ Subcategoría</label>
        <select id="sub_categoria" class="swal2-input" style="width: 100%; height: 45px; font-size: 16px;">
          <option value="">-- Selecciona una subcategoría --</option>
          ${subCategoriaOptions}
        </select>

        <label for="concepto" style="margin-top: 10px;">📝 Concepto</label>
        <input type="text" id="concepto" class="swal2-input" placeholder="Descripción" style="width: 100%; height: 45px; font-size: 16px; margin-left:0px">

        <label for="cantidad" style="margin-top: 10px;">💶 Cantidad (€)</label>
        <input type="number" id="cantidad" class="swal2-input" placeholder="Ej: 200" style="width: 100%; height: 45px; font-size: 16px; margin-left:0px">
      </div>
    `,
    confirmButtonText: '💾 Guardar',
    customClass: {
      popup: 'swal2-modal-centered'
    },
    focusConfirm: false,
    preConfirm: () => {
      const fecha = document.getElementById('fecha').value;
      const categoria = document.getElementById('categoria').value;
      const concepto = document.getElementById('concepto').value;
      const cantidad = parseFloat(document.getElementById('cantidad').value);
      const sub_categoria = document.getElementById('sub_categoria').value;

      if (!fecha || !concepto || isNaN(cantidad) || !sub_categoria) {
        Swal.showValidationMessage('Todos los campos son obligatorios');
        return false;
      }

      return { fecha, categoria, concepto, cantidad, sub_categoria };
    }
  }).then(result => {
    if (result.isConfirmed) {
      const data = result.value;

      fetch('./controllers/crear_movimiento.php', {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
      })
        .then(res => res.json())
        .then(() => {
          initMovimientos();
          Swal.fire('✅ Éxito', 'Movimiento creado correctamente', 'success');
        })
        .catch(err => {
          console.error(err);
          Swal.fire('❌ Error', 'No se pudo crear el movimiento', 'error');
        });
    }
  });
}


function nuevaSubCategoria() {

  Swal.fire({
    title: 'Nueva Subcategoria',
    html: `
      <div style="display: flex; flex-direction: column; align-items: stretch; width: 100%; max-width: 500px; margin: auto; font-size: 16px;">

        <label for="nombreSubcategoria" style="margin-top: 10px;">📝 Nombre</label>
        <input type="text" id="nombreSubcategoria" class="swal2-input" placeholder="Nombre" style="width: 100%; height: 45px; font-size: 16px; margin-left:0px">

      </div>
    `,
    confirmButtonText: '💾 Guardar',
    customClass: {
      popup: 'swal2-modal-centered'
    },
    focusConfirm: false,
    preConfirm: () => {
      const nombreSubcategoria = document.getElementById('nombreSubcategoria').value;

      if (!nombreSubcategoria) {
        Swal.showValidationMessage('Todos los campos son obligatorios');
        return false;
      }

      return { nombreSubcategoria };
    }
  }).then(result => {
    if (result.isConfirmed) {
      const data = result.value;

      fetch('./controllers/crear_subcategoria.php', {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
      })
        .then(res => res.json())
        .then(() => {

          window.location.reload();

        })
        .catch(err => {
          console.error(err);
          Swal.fire('❌ Error', 'No se pudo crear la Subcategoria', 'error');
        });
    }
  });
}




  </script>


</body>

</html>