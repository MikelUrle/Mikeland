<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <title>Mikeland</title>
    <link rel="stylesheet" href="./styles/menu.css">
    <link rel="stylesheet" href="./styles/index.css">
    <link rel="stylesheet" href="./styles/finanzas.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js" defer></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-LN+7fdVzj6u52u30Kp6M/trliBMCMKTyK833zpbD+pXdCLuTusPj697FH4R/5mcr" crossorigin="anonymous">
    <style>
        #tareas {
            max-width: 700px;
            margin: 20px auto;
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 8px rgba(0, 0, 0, 0.1);
        }

        #acciones-categorias {
            margin-bottom: 15px;
            text-align: right;
        }

        #acciones-categorias button {
            padding: 8px 15px;
            background-color: #a42aaf;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        #acciones-tareas {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        #acciones-tareas input,
        #acciones-tareas select {
            flex: 1;
            padding: 8px;
        }

        #acciones-tareas button {
            padding: 8px 15px;
            background-color: #27ae60;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .categoria-titulo {
            margin-top: 20px;
            font-weight: bold;
            color: #333;
            border-bottom: 2px solid #ccc;
            padding-bottom: 4px;
        }

        .lista-categoria {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .lista-categoria li {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            border-bottom: 1px solid #ddd;
        }


        .btn-borrar {
            background: red;
            color: white;
            border: none;
            padding: 4px 8px;
            cursor: pointer;
            border-radius: 4px;
        }


.lista-categoria li {
    cursor: pointer;
    padding: 10px;          /* área clicable más grande */
    margin-bottom: 5px;
    border-radius: 5px;
    transition: background-color 0.2s;
    display: flex;
    justify-content: space-between; /* para que el texto y el botón estén separados */
    align-items: center;
}

.tarea-completada {
    background-color: #4caf50; /* fondo verde completo */
    color: white;              /* texto blanco */
}


    </style>
</head>

<body>

    <div id="sidebar"></div>

    <div class="main">
        <section id="tareas">
            <h2>Mis Tareas</h2>

            <div id="acciones-categorias">
                <button onclick="nuevaCategoria()">+ Añadir Categoría</button>
            </div>

            <div id="acciones-tareas">
                <input type="text" id="nueva-tarea" placeholder="Escribe una tarea...">
                <select id="categoria-tarea"></select>
                <button onclick="agregarTarea()" id="btn-add-tarea">Añadir</button>
            </div>

            <div id="lista-tareas"></div>
        </section>
    </div>

    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-ndDqU0Gzau9qJ1lfW4pNLlhNTkCfHzAVBReH9diLvGRem5+R9g2FzA8ZGN954O5Q"
        crossorigin="anonymous"></script>
    <script defer>
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            fetch('./menu.html')
                .then(res => res.text())
                .then(html => {
                    document.getElementById('sidebar').innerHTML = html;
                });
        });

        const listaTareasDiv = document.getElementById('lista-tareas');
        const inputTarea = document.getElementById('nueva-tarea');
        const btnAddTarea = document.getElementById('btn-add-tarea');
        const selectorCategoria = document.getElementById('selector-categoria');
        const btnAddCategoria = document.getElementById('btn-add-categoria');

        let categorias = [];
        let tareas = [];

        cargarCategorias();
        cargarTareas();

        // Renderizar categorías en el selector
        async function cargarCategorias() {
            await fetch('./controllers/tareas/lista_categorias.php')
                .then(res => res.json())
                .then(categorias => {
                    const select = document.getElementById('categoria-tarea');
                    select.innerHTML = ''; // Limpiar por si acaso
                    categorias.forEach(cat => {
                        const option = document.createElement('option');
                        option.value = cat.id_categoria;
                        option.textContent = cat.nombre;
                        select.appendChild(option);
                    });
                })
                .catch(err => console.error('Error cargando categorías:', err));
        }

        async function agregarTarea() {
            const texto = document.getElementById('nueva-tarea').value.trim();
            const id_categoria = document.getElementById('categoria-tarea').value;

            if (!texto || !id_categoria) {
                Swal.fire('Error', 'Rellena el texto y selecciona una categoría', 'warning');
                return;
            }

            try {
                const res = await fetch('./controllers/tareas/anadir_tarea.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ texto, id_categoria })
                });

                const data = await res.json();

                if (data.success) {
                    document.getElementById('nueva-tarea').value = '';
                    cargarTareas(); // recargamos las tareas
                } else {
                    Swal.fire('Error', 'No se pudo crear la tarea', 'error');
                }

            } catch (err) {
                console.error('Error al añadir tarea:', err);
                Swal.fire('Error', 'Error al comunicarse con el servidor', 'error');
            }
        }


        async function borrarTarea(id_tarea) {
            const confirm = await Swal.fire({
                title: '¿Eliminar tarea?',
                text: "Se marcará como borrada",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Sí, borrar',
                cancelButtonText: 'Cancelar',
                customClass: {
                    confirmButton: 'btn btn-danger',
                    cancelButton: 'btn btn-secondary ms-2' // ms-2 añade margen a la izquierda
                },
                buttonsStyling: false
            });

            if (confirm.isConfirmed) {
                try {
                    const res = await fetch('./controllers/tareas/borrar_tarea.php', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ id_tarea })
                    });

                    const data = await res.json();

                    if (data.success) {
                        // Marcamos localmente como borrada también
                        const tarea = tareas.find(t => t.id_tarea == id_tarea);
                        if (tarea) tarea.isDeleted = 1;
                        window.location.reload();
                    } else {
                        Swal.fire('Error', 'No se pudo borrar la tarea', 'error');
                    }
                } catch (err) {
                    console.error(err);
                    Swal.fire('Error', 'Error de comunicación con el servidor', 'error');
                }
            }
        }


        function nuevaCategoria() {
            Swal.fire({
                title: 'Nueva Categoría',
                input: 'text',
                inputLabel: 'Introduce el nombre de la nueva categoría',
                inputPlaceholder: 'Ej: Trabajo, Personal, Urgente...',
                showCancelButton: true,
                confirmButtonText: 'Añadir',
                cancelButtonText: 'Cancelar',
                inputValidator: (value) => {
                    if (!value || value.trim() === '') {
                        return 'Por favor, introduce un nombre válido';
                    }
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    const nombre = result.value.trim();
                    const formData = new FormData();
                    formData.append('nombreCategoria', nombre);

                    fetch('./controllers/tareas/anadir_categoria.php', {
                        method: 'POST',
                        body: formData
                    })
                        .then(res => res.json())
                        .then(data => {
                            if (data.success) {
                                Swal.fire({
                                    icon: 'success',
                                    title: 'Categoría añadida',
                                    showConfirmButton: false,
                                    timer: 1500
                                });
                                cargarCategorias();
                            } else {
                                Swal.fire({
                                    icon: 'error',
                                    title: 'Error al añadir categoría',
                                    text: data.error || ''
                                });
                            }
                        });
                }
            });
        }

        // Añadir tarea
        // btnAddTarea.addEventListener('click', () => {
        //     const texto = inputTarea.value.trim();
        //     const categoria = selectorCategoria.value;
        //     if (!texto) return;
        //     tareas.push({ texto, categoria, completada: false });
        //     inputTarea.value = '';
        //     renderTareas();
        // });


        async function cargarTareas() {
            try {
                const res = await fetch('./controllers/tareas/lista_tareas.php');
                const data = await res.json();

                // Filtramos solo las no borradas
                tareas = data.filter(t => t.isDeleted == "0"); // compara con string, porque viene como string

                // Generamos la lista de categorías automáticamente según las tareas
                categorias = [...new Set(tareas.map(t => t.nombre_categoria))];

                renderTareas();
            } catch (err) {
                console.error('Error al cargar tareas:', err);
            }
        }



function renderTareas() {
    listaTareasDiv.innerHTML = '';

    categorias.forEach(cat => {
        const tareasCat = tareas.filter(t => t.nombre_categoria === cat);

        if (tareasCat.length > 0) {
            const h3 = document.createElement('h3');
            h3.classList.add('categoria-titulo');
            h3.textContent = cat;
            listaTareasDiv.appendChild(h3);

            const ul = document.createElement('ul');
            ul.classList.add('lista-categoria');

tareasCat.forEach(tarea => {
    const li = document.createElement('li');
    li.className = 'tarea-item'; // clase para estilo

    // Aplicamos color de fondo según estado
    if (tarea.estado == 1) {
        li.classList.add('tarea-completada');
    }

    // Evento de doble clic sobre todo el li
    li.addEventListener('dblclick', () => toggleCompletarTarea(tarea.id_tarea));

    // Texto de la tarea
    const span = document.createElement('span');
    span.textContent = tarea.texto;

    // Botón de borrar
    const btnBorrar = document.createElement('button');
    btnBorrar.className = 'btn-borrar';
    btnBorrar.textContent = 'X';
    btnBorrar.addEventListener('click', e => {
        e.stopPropagation(); // evitar que se active el dblclick del li
        borrarTarea(tarea.id_tarea);
    });

    li.appendChild(span);
    li.appendChild(btnBorrar);
    ul.appendChild(li);
});

            listaTareasDiv.appendChild(ul);
        }
    });
}

function toggleCompletarTarea(id_tarea) {
    const tarea = tareas.find(t => t.id_tarea == id_tarea);
    if (!tarea) return;

    tarea.estado = tarea.estado == 1 ? 0 : 1; // alterna entre 0 y 1
    renderTareas();

    // Aquí puedes añadir un fetch a tu PHP para actualizar el estado en la DB
    fetch(`./controllers/tareas/completar_tarea.php?id=${id_tarea}`, { method: 'POST' });
}


        function toggleCompletar(id_tarea) {
            const tarea = tareas.find(t => t.id_tarea === id_tarea);
            if (!tarea) return;

            // Alternamos el estado: 0 -> 1, 1 -> 0
            tarea.estado = tarea.estado == 1 ? 0 : 1;

            // Si luego quieres sincronizar con la DB, aquí harías un fetch PUT/POST
            // fetch('./controllers/tareas/actualizar_estado.php', { ... })

            renderTareas();
        }




    </script>


</body>

</html>